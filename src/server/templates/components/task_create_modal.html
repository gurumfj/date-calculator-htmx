{% import "macros/_icons.html" as icons %}

<!-- 任務創建 Modal -->
<div id="task-create-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">新增任務</h3>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-gray-600">
                                        {{ icons.x_mark(class="w-6 h-6") }}
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <form id="task-create-form" 
                      hx-post="todo/create" 
                      hx-target="#task-create-form"
                      hx-swap="outerHTML"
                      hx-indicator="#create-task-loading">
                    <input type="hidden" name="batch_name" id="modal-batch-name" value="">
                    
                    <div class="space-y-4">
                        <!-- 任務內容 -->
                        <div>
                            <label for="modal-task-content" class="block text-sm font-medium text-gray-700 mb-1">任務內容 *</label>
                            <input type="text" 
                                   id="modal-task-content" 
                                   name="content" 
                                   required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="輸入任務內容...">
                        </div>
                        
                        <!-- 到期日 -->
                        <div>
                            <label for="modal-task-due-date" class="block text-sm font-medium text-gray-700 mb-1">到期日</label>
                            <input type="date" 
                                   id="modal-task-due-date" 
                                   name="due_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- 描述 -->
                        <div>
                            <label for="modal-task-description" class="block text-sm font-medium text-gray-700 mb-1">描述 (支援 Markdown)</label>
                            <textarea id="modal-task-description" 
                                      name="description" 
                                      rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="輸入任務描述..."></textarea>
                            <p class="mt-1 text-xs text-gray-500">支援 Markdown 格式：**粗體**、*斜體*、`代碼`</p>
                        </div>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                        <button type="button" 
                                onclick="closeTaskModal()" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            取消
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center gap-2"
                                title="創建新任務">
                                                        {{ icons.plus_solid(class="w-4 h-4") }}
                            創建任務
                            <div id="create-task-loading" class="htmx-indicator">
                                <div class="loading-spinner w-4 h-4"></div>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function openTaskModal(batchName) {
    document.getElementById('modal-batch-name').value = batchName;
    document.getElementById('task-create-modal').classList.remove('hidden');
    document.getElementById('modal-task-content').focus();
}

function closeTaskModal() {
    document.getElementById('task-create-modal').classList.add('hidden');
    // 重置表單
    document.getElementById('task-create-form').reset();
}

// ESC 鍵關閉 Modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTaskModal();
    }
});

// 點擊背景關閉 Modal
document.getElementById('task-create-modal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeTaskModal();
    }
});

// 監聽任務創建成功事件，關閉 Modal
document.body.addEventListener('taskCreated', function() {
    closeTaskModal();
});
</script>