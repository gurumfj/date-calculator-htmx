<section>
    <h4 class="font-bold text-black mb-2 pb-1">結場資料</h4>
    {% if production_data %}
        {% for production in production_data %}
        <div class="mb-4">
            <!-- 基本資訊標題 -->
            <div class="bg-gray-100 p-2 mb-1">
                <h5 class="font-bold">{{ production.batch_name }}</h5>
                <div class="flex gap-4 text-sm">
                    <span>場地: {{ production.farm_location or '-' }}</span>
                    <span>農戶: {{ production.farmer or '-' }}</span>
                    <span>結場日期: {{ production.created_at or '-' }}</span>
                </div>
            </div>

            <!-- 關鍵指標 -->
            <div class="bg-blue-50 p-2 mb-1">
                <h6 class="font-bold mb-1">關鍵指標</h6>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                    <div class="text-center">
                        <div class="font-bold">{{ "%.2f"|format(production.fcr or 0) }}</div>
                        <div>飼料換肉率</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold">{{ "%.1f"|format(production.survival_rate or 0) }}%</div>
                        <div>成活率</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold">{{ "%.1f"|format(production.profit_margin or 0) }}%</div>
                        <div>利潤率</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold">{{ "%.2f"|format(production.avg_weight_per_chicken or 0) }}</div>
                        <div>平均重量(斤/隻)</div>
                    </div>
                </div>
            </div>

            <!-- 生產數據 -->
            <table class="table w-full ml-4 mb-2">
                <thead class="hidden sm:table-header-group">
                    <tr class="bg-gray-100">
                        <th class="p-2 text-left font-bold">項目</th>
                        <th class="p-2 text-left font-bold">數值</th>
                        <th class="p-2 text-left font-bold">項目</th>
                        <th class="p-2 text-left font-bold">數值</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">進雛數</td>
                        <td class="p-2">{{ (production.chick_in_count or 0)|format_number }} 隻</td>
                        <td class="p-2">銷售重量</td>
                        <td class="p-2">{{ "%.1f"|format(production.sale_weight_jin or 0) }} 斤</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">出雞數</td>
                        <td class="p-2">{{ (production.chicken_out_count or 0)|format_number }} 隻</td>
                        <td class="p-2">平均價格</td>
                        <td class="p-2">{{ "%.2f"|format(production.avg_price or 0) }} 元</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">飼料重量</td>
                        <td class="p-2">{{ "%.1f"|format(production.feed_weight or 0) }} 斤</td>
                        <td class="p-2">成本價格</td>
                        <td class="p-2">{{ "%.2f"|format(production.cost_price or 0) }} 元</td>
                    </tr>
                    <!-- 手機版顯示 -->
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">進雛數</span><span>{{ (production.chick_in_count or 0)|format_number }} 隻</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">出雞數</span><span>{{ (production.chicken_out_count or 0)|format_number }} 隻</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">飼料重量</span><span>{{ "%.1f"|format(production.feed_weight or 0) }} 斤</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">銷售重量</span><span>{{ "%.1f"|format(production.sale_weight_jin or 0) }} 斤</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">平均價格</span><span>{{ "%.2f"|format(production.avg_price or 0) }} 元</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">成本價格</span><span>{{ "%.2f"|format(production.cost_price or 0) }} 元</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- 財務分析 -->
            <div class="bg-green-50 p-2 mb-1">
                <h6 class="font-bold mb-1">收支概況</h6>
                <div class="grid grid-cols-3 gap-2 text-sm text-center">
                    <div>
                        <div class="font-bold">{{ (production.revenue or 0)|format_number }}</div>
                        <div>營收</div>
                    </div>
                    <div>
                        <div class="font-bold">{{ ((production.expenses or 0) * -1)|format_number }}</div>
                        <div>支出</div>
                    </div>
                    <div>
                        <div class="font-bold {% if production.profit >= 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ (production.profit or 0)|format_number }}</div>
                        <div>利潤</div>
                    </div>
                </div>
            </div>

            <!-- 成本明細 -->
            {% set total_cost = (production.feed_cost or 0) + (production.chick_cost or 0) + (production.vet_cost or 0) + (production.grow_fee or 0) + (production.catch_fee or 0) + (production.leg_band_cost or 0) + (production.weigh_fee or 0) + (production.gas_cost or 0) + (production.feed_med_cost or 0) + (production.farm_med_cost or 0) %}
            <table class="table w-full ml-4">
                <thead class="hidden sm:table-header-group">
                    <tr class="bg-gray-100">
                        <th class="p-2 text-left font-bold">成本項目</th>
                        <th class="p-2 text-left font-bold">金額</th>
                        <th class="p-2 text-left font-bold">佔比</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">飼料成本</td>
                        <td class="p-2">{{ (production.feed_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.feed_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">雛雞成本</td>
                        <td class="p-2">{{ (production.chick_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.chick_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">獸醫成本</td>
                        <td class="p-2">{{ (production.vet_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.vet_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">代養費</td>
                        <td class="p-2">{{ (production.grow_fee or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.grow_fee or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">抓工費</td>
                        <td class="p-2">{{ (production.catch_fee or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.catch_fee or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">腳環費</td>
                        <td class="p-2">{{ (production.leg_band_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.leg_band_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">過磅費</td>
                        <td class="p-2">{{ (production.weigh_fee or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.weigh_fee or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">瓦斯費</td>
                        <td class="p-2">{{ (production.gas_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.gas_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">飼料用藥</td>
                        <td class="p-2">{{ (production.feed_med_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.feed_med_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <tr class="hidden sm:table-row">
                        <td class="p-2">農場用藥</td>
                        <td class="p-2">{{ (production.farm_med_cost or 0)|format_number }}</td>
                        <td class="p-2">{% if total_cost > 0 %}{{ "%.1f"|format((production.farm_med_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %}</td>
                    </tr>
                    <!-- 手機版顯示 -->
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-center border-b border-gray-200">
                            <span class="font-bold">成本明細</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">飼料成本</span>
                            <span>{{ (production.feed_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.feed_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">雛雞成本</span>
                            <span>{{ (production.chick_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.chick_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">獸醫成本</span>
                            <span>{{ (production.vet_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.vet_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">代養費</span>
                            <span>{{ (production.grow_fee or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.grow_fee or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">抓工費</span>
                            <span>{{ (production.catch_fee or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.catch_fee or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">腳環費</span>
                            <span>{{ (production.leg_band_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.leg_band_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">過磅費</span>
                            <span>{{ (production.weigh_fee or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.weigh_fee or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">瓦斯費</span>
                            <span>{{ (production.gas_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.gas_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">飼料用藥</span>
                            <span>{{ (production.feed_med_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.feed_med_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">農場用藥</span>
                            <span>{{ (production.farm_med_cost or 0)|format_number }} ({% if total_cost > 0 %}{{ "%.1f"|format((production.farm_med_cost or 0) * 100 / total_cost) }}%{% else %}-{% endif %})</span>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="hidden sm:table-row">
                        <td class="p-2 font-bold">總計</td>
                        <td class="p-2 italic">{{ total_cost|format_number }}</td>
                        <td class="p-2 italic">100.0%</td>
                    </tr>
                    <tr class="border-b border-black sm:hidden">
                        <td class="px-8 py-2 flex items-center justify-between border-b border-gray-200">
                            <span class="font-bold">總計</span><span class="italic">{{ total_cost|format_number }}</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endfor %}
    {% else %}
        <p class="p-4 text-center text-gray-600">此批次無結場記錄</p>
    {% endif %}
</section>