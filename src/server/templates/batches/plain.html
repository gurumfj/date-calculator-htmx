{% import "macros/_icons.html" as icons %}

{% macro batch_summary(batch) %}
<li class="border-b last:border-b-0 even:bg-gray-50">
    <a href="/batches/breed?batch_name={{ batch['batch_name'] }}" class="group flex items-center justify-between p-4 hover:bg-gray-100 transition-colors duration-200">
        <div class="flex items-center gap-4">
            {% if batch.get("fcr") %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-green-100 text-green-800">
                {{ icons.checkmark(class="w-4 h-4 mr-1.5") }}
                {{"%.2f"|format(batch["fcr"])}}
            </span>
            {% elif batch.get("percentage") %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                {{"%.1f"|format(batch["percentage"])}}%
            </span>
            {% else %}
                <div class="flex items-center gap-2">
                {% for breed in batch["breed_details"] %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                    {{breed["week_age"]}}
                </span>
                {% endfor %}
                </div>
            {% endif %}
            <span class="text-base font-medium text-gray-800">{{ batch["batch_name"] }}</span>
        </div>
        {{ icons.chevron_right(class="w-5 h-5 text-gray-400 group-hover:text-gray-500 transition-colors") }}
    </a>
</li>
{% endmacro %}

{% macro plain_content(batches) %}
<ul id="batches-container">
    {% for batch in batches %}
    {{ batch_summary(batch) }}
    {% endfor %}
</ul>
{% if has_more %}
<div hx-get="?chicken_breed={{ chicken_breed }}&view=plain-content&offset={{ next_offset }}" hx-trigger="revealed"
    hx-swap="outerHTML" class="p-4 text-center border-t bg-gray-50">
    <button class="btn btn-link">載入更多...</button>
</div>
{% endif %}
{% endmacro %}

{% if view == "plain" %}
{% extends "base.html" %}

{% block title %}批次摘要{% endblock %}

{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">批次摘要</h1>

    <div class="card" x-data="{ selectedBreed: '{{ chicken_breed or '' }}' }">
        <div class="card-header p-4 border-b bg-gray-50">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- Chicken Breed Tabs -->
                <div class="tabs">
                    <div class="tabs-list" role="tablist" aria-label="雞種選擇">
                        {% for breed in chicken_breeds %}
                        <div role="tab" class="tabs-trigger"
                             :aria-selected="selectedBreed === '{{ breed }}'"
                             @click="selectedBreed = '{{ breed }}'"
                             hx-get="?chicken_breed={{ breed }}&view=plain-content"
                             hx-target="#content-container"
                             hx-swap="innerHTML">
                            {{ breed }}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Search Form -->
                <form id="search-form" class="flex items-center gap-2" hx-get="" hx-target="#content-container" hx-swap="innerHTML">
                    <input type="hidden" name="chicken_breed" :value="selectedBreed">
                    <input type="hidden" name="view" value="plain-content">
                    <input type="text" id="batch_name" name="batch_name" value="{{ batch_name or '' }}" class="input" placeholder="批次名稱搜尋...">
                    <button type="submit" class="btn btn-primary">搜尋</button>
                    <button type="button" onclick="this.form.batch_name.value=''; this.form.requestSubmit();" class="btn">清除</button>
                </form>
            </div>
        </div>
        <div id="content-container">
            {{ plain_content(batches) }}
        </div>
    </div>
</div>
{% endblock %}

{% elif view == "plain-content" %}
{{ plain_content(batches) }}

{% elif view == "actions-only" %}
{{ batch_actions(batch) }}

{% endif%}